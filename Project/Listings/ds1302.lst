C51 COMPILER V9.60.0.0   DS1302                                                            09/09/2021 14:39:46 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\ds1302.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\Src\ds1302.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Inc) DEBUG OBJECTEXTE
                    -ND PRINT(.\Listings\ds1302.lst) OBJECT(.\Objects\ds1302.obj)

line level    source

   1          #include "main.h"
   2          #include "bsp_lib.h"
   3          #include <stdio.h>
   4          #include "ds1302.h"
   5          struct DS1302_time my_time;
   6          // 各寄存器的写命令。KEIL对中文支持不太好，原文注释这里原样表述一遍
   7          #define SECOND_REG_WRITE 0x80
   8          #define MINUTE_REG_WRITE 0x82
   9          #define HOUR_REG_WRITE 0x84
  10          #define DAY_REG_WRITE 0x86
  11          #define MONTH_REG_WRITE 0x88
  12          #define WEEK_REG_WRITE 0x8A
  13          #define YEAR_REG_WRITE 0x8C
  14          
  15          // 各寄存器的读命令
  16          #define SECOND_REG_READ 0x81
  17          #define MINUTE_REG_READ 0x83
  18          #define HOUR_REG_READ 0x85
  19          #define DAY_REG_READ 0x87
  20          #define MONTH_REG_READ 0x89
  21          #define WEEK_REG_READ 0x8B
  22          #define YEAR_REG_READ 0x8D
  23          
  24          // 向DS1302写入一个字节
  25          void DS1302_WriteByte(u8 writeByte)
  26          {
  27   1          u8 retry = 0;
  28   1          // DS1302 接收或发送数据时，低位在前，高位在后
  29   1          for (retry = 0; retry != 8; ++retry)
  30   1          {
  31   2              if (1 == (writeByte & 0x01))
  32   2              {
  33   3                  DS1302_IO = 1;
*** ERROR C202 IN LINE 33 OF ..\Src\ds1302.c: 'DS1302_IO': undefined identifier
  34   3              }
  35   2              else
  36   2              {
  37   3                  DS1302_IO = 0;
*** ERROR C202 IN LINE 37 OF ..\Src\ds1302.c: 'DS1302_IO': undefined identifier
  38   3              }
  39   2              // 参考了别人的例程，这里竟然不需要延时..好吧
  40   2              DS1302_SCK = 1;
*** ERROR C202 IN LINE 40 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  41   2              DS1302_SCK = 0;
*** ERROR C202 IN LINE 41 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  42   2              writeByte >>= 1;
  43   2          }
  44   1      }
  45          
  46          // 从DS1302中读出一个字节
  47          u8 DS1302_ReadByte(void)
  48          {
  49   1          u8 retry = 0;
  50   1          u8 readByte = 0;
C51 COMPILER V9.60.0.0   DS1302                                                            09/09/2021 14:39:46 PAGE 2   

  51   1          // 最低位在前，高位在后。跟一般的通讯不太一样
  52   1          for (retry = 0; retry != 8; ++retry)
  53   1          {
  54   2              readByte >>= 1;
  55   2              if (DS1302_IO)
*** ERROR C202 IN LINE 55 OF ..\Src\ds1302.c: 'DS1302_IO': undefined identifier
  56   2              {
  57   3                  readByte |= 0x80;
  58   3              }
  59   2              DS1302_SCK = 1;
*** ERROR C202 IN LINE 59 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  60   2              DS1302_SCK = 0;
*** ERROR C202 IN LINE 60 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  61   2          }
  62   1          return readByte;
  63   1      }
  64          
  65          // 向某个寄存器写入一个字节数值
  66          void DS1302_WriteReg(u8 addr, u8 value)
  67          {
  68   1          DS1302_RST = 0;
*** ERROR C202 IN LINE 68 OF ..\Src\ds1302.c: 'DS1302_RST': undefined identifier
  69   1          DS1302_SCK = 0;
*** ERROR C202 IN LINE 69 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  70   1          DS1302_RST = 1;
*** ERROR C202 IN LINE 70 OF ..\Src\ds1302.c: 'DS1302_RST': undefined identifier
  71   1          DS1302_WriteByte(addr);
  72   1          DS1302_WriteByte(value);
  73   1          DS1302_SCK = 1;
*** ERROR C202 IN LINE 73 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  74   1          DS1302_RST = 0;
*** ERROR C202 IN LINE 74 OF ..\Src\ds1302.c: 'DS1302_RST': undefined identifier
  75   1      }
  76          
  77          // 读取某个寄存器的值
  78          u8 DS1302_ReadReg(u8 addr)
  79          {
  80   1          u8 readByte = 0;
  81   1          DS1302_RST = 0;
*** ERROR C202 IN LINE 81 OF ..\Src\ds1302.c: 'DS1302_RST': undefined identifier
  82   1          DS1302_SCK = 0;
*** ERROR C202 IN LINE 82 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  83   1          DS1302_RST = 1;
*** ERROR C202 IN LINE 83 OF ..\Src\ds1302.c: 'DS1302_RST': undefined identifier
  84   1          DS1302_WriteByte(addr);
  85   1          readByte = DS1302_ReadByte();
  86   1          DS1302_SCK = 1;
*** ERROR C202 IN LINE 86 OF ..\Src\ds1302.c: 'DS1302_SCK': undefined identifier
  87   1          DS1302_RST = 0;
*** ERROR C202 IN LINE 87 OF ..\Src\ds1302.c: 'DS1302_RST': undefined identifier
  88   1      
  89   1          return readByte;
  90   1      }
  91          
  92          // DS1302的初始化
  93          void DS1302_Init(void)
  94          {
  95   1          // 先关闭写保护
  96   1          DS1302_WriteReg(0x8E, 0x00);
  97   1          // 设置时间，秒、分、时等等，注意噢，写入的是BCD码
  98   1          DS1302_WriteReg(SECOND_REG_WRITE, 0);
  99   1          DS1302_WriteReg(MINUTE_REG_WRITE, 0x20);
C51 COMPILER V9.60.0.0   DS1302                                                            09/09/2021 14:39:46 PAGE 3   

 100   1          DS1302_WriteReg(HOUR_REG_WRITE, 0x17);
 101   1          DS1302_WriteReg(DAY_REG_WRITE, 0x52);
 102   1          DS1302_WriteReg(MONTH_REG_WRITE, 0x12);
 103   1          DS1302_WriteReg(YEAR_REG_WRITE, 0x13);
 104   1          DS1302_WriteReg(WEEK_REG_WRITE, 0x04);
 105   1      
 106   1          // 一些设置后，继续开户写保护
 107   1          DS1302_WriteReg(0x90, 0x01);
 108   1          DS1302_WriteReg(0xC0, 0xF0);
 109   1          DS1302_WriteReg(0x8E, 0x80);
 110   1      }
 111          
 112          // 读时间，然后在八段数码管上显示出来
 113          void get_time(void)
 114          {
 115   1          u8 hour_, min_, sec_;
 116   1      
 117   1          hour_ = DS1302_ReadReg(HOUR_REG_READ);
 118   1          // BCD码转换成十六进制
 119   1          hour_ = (hour_ / 16) * 10 + (hour_ % 16);
 120   1      
 121   1          min_ = DS1302_ReadReg(MINUTE_REG_READ);
 122   1          min_ = (min_ / 16) * 10 + (min_ % 16);
 123   1      
 124   1          sec_ = DS1302_ReadReg(SECOND_REG_READ);
 125   1          sec_ = (sec_ / 16) * 10 + (sec_ % 16);
 126   1          my_time.hour=hour_;
 127   1          my_time.min=min_;
 128   1          my_time.sec=sec_;
 129   1      }

C51 COMPILATION COMPLETE.  0 WARNING(S),  17 ERROR(S)
